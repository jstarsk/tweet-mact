<html>
<head>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>
    <!--<link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.3/mapbox.css' rel='stylesheet'/>-->
    <!--<script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.3/mapbox.js'></script>-->
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.24.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.24.0/mapbox-gl.css' rel='stylesheet'/>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script>

    let _GeoJSONCircle = function (center, radiusInKm, points) {
        if (!points) points = 64;

        let coords = {
            latitude: center[1],
            longitude: center[0]
        };

        let km = radiusInKm;

        let ret = [];
        let distanceX = km / (111.320 * Math.cos(coords.latitude * Math.PI / 180));
        let distanceY = km / 110.574;

        let theta, x, y;
        for (let i = 0; i < points; i++) {
            theta = (i / points) * (2 * Math.PI);
            x = distanceX * Math.cos(theta);
            y = distanceY * Math.sin(theta);

            ret.push([coords.longitude + x, coords.latitude + y]);
        }
        ret.push(ret[0]);

        return [ret]
    };

    mapboxgl.accessToken = '{{ACCESS_KEY}}';

    let $_tweets_locations = {{tweets_locations|safe}};

    let map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v9',
        center: ['{{center_lon}}', '{{center_lat}}'],
        zoom: '{{map_zoom}}'
    });


    let tweets_locations = {
        "type": "FeatureCollection",
        "features": $_tweets_locations.map(function (tl) {
            return {
                "type": "Feature",
                "geometry": {
                    "type": "Polygon",
                    "coordinates": _GeoJSONCircle(tl.geometry.coordinates, tl.properties.diameter, 32)
                }
            };

        })
    };

    map.on('load', function () {
                map.addSource("tweets_locations", {
                    "type": "geojson",
                    "data": tweets_locations
                });

                map.addLayer({
                    "id": "tweets_locations",
                    "type": "fill",
                    "source": "tweets_locations",
                    'layout': {},
                    'paint': {
                        'fill-color': '#088',
                        'fill-opacity': 0.01
                    },
                    "filter": ["==", "$type", "Polygon"]
                });
            }
    );

</script>
</body>
</html>